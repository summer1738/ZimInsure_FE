<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Car Management</h2>
    <button class="btn btn-primary" (click)="showAddModal()">Add Car</button>
  </div>
  <div class="mb-3">
    <input type="text" class="form-control" placeholder="Search cars..." [(ngModel)]="searchTerm$.value" (ngModelChange)="onSearch($event)">
  </div>
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th (click)="onSort('regNumber')" style="cursor:pointer">Reg Number <span *ngIf="sortColumn$.value === 'regNumber'">{{ sortDirection$.value === 'asc' ? '▲' : '▼' }}</span></th>
          <th (click)="onSort('make')" style="cursor:pointer">Make <span *ngIf="sortColumn$.value === 'make'">{{ sortDirection$.value === 'asc' ? '▲' : '▼' }}</span></th>
          <th (click)="onSort('model')" style="cursor:pointer">Model <span *ngIf="sortColumn$.value === 'model'">{{ sortDirection$.value === 'asc' ? '▲' : '▼' }}</span></th>
          <th (click)="onSort('year')" style="cursor:pointer">Year <span *ngIf="sortColumn$.value === 'year'">{{ sortDirection$.value === 'asc' ? '▲' : '▼' }}</span></th>
          <th (click)="onSort('owner')" style="cursor:pointer">Owner <span *ngIf="sortColumn$.value === 'owner'">{{ sortDirection$.value === 'asc' ? '▲' : '▼' }}</span></th>
          <th>Insurance Term</th>
          <th>Insurance Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let car of filteredCars$ | async">
          <td>{{ car.regNumber }}</td>
          <td>{{ car.make }}</td>
          <td>{{ car.model }}</td>
          <td>{{ car.year }}</td>
          <td>{{ car.owner }}</td>
          <td>
            <ng-container *ngIf="getCurrentInsuranceTerm(car.id) | async as term">
              {{ term?.startDate }} - {{ term?.endDate }}
            </ng-container>
            <ng-template #noTerm>-</ng-template>
          </td>
          <td>
            <span [ngClass]="{'text-success': (getInsuranceStatus(car.id) | async) === 'Active', 'text-danger': (getInsuranceStatus(car.id) | async) === 'Expired'}">
              {{ getInsuranceStatus(car.id) | async }}
            </span>
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-2" (click)="showEditModal(car)">Edit</button>
            <button class="btn btn-sm btn-outline-danger me-2" (click)="deleteCar(car.id)">Delete</button>
            <button *ngIf="userRole === 'AGENT' || userRole === 'SUPER_ADMIN'" class="btn btn-sm btn-outline-success" (click)="showInsuranceModal(car)">Insure</button>
          </td>
        </tr>
        <tr *ngIf="(filteredCars$ | async)?.length === 0">
          <td colspan="8" class="text-center">No cars found.</td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- Pagination -->
  <nav *ngIf="totalCars > pageSize">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage$.value === 1">
        <a class="page-link" (click)="onPageChange(currentPage$.value - 1)" style="cursor:pointer">Previous</a>
      </li>
      <li class="page-item" *ngFor="let _ of totalPages; let idx = index" [class.active]="currentPage$.value === idx + 1">
        <a class="page-link" (click)="onPageChange(idx + 1)" style="cursor:pointer">{{ idx + 1 }}</a>
      </li>
      <li class="page-item" [class.disabled]="currentPage$.value === totalPages.length">
        <a class="page-link" (click)="onPageChange(currentPage$.value + 1)" style="cursor:pointer">Next</a>
      </li>
    </ul>
  </nav>

  <!-- Modal -->
  <div class="modal fade show" tabindex="-1" style="display: block; background: rgba(0,0,0,0.3);" *ngIf="isModalVisible">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ isEditMode ? 'Edit Car' : 'Add Car' }}</h5>
          <button type="button" class="btn-close" (click)="handleModalCancel()"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="handleModalOk(selectedCar)">
            <div class="mb-3">
              <label class="form-label">Reg Number</label>
              <input type="text" class="form-control" [(ngModel)]="selectedCar.regNumber" name="regNumber" maxlength="7" required [ngClass]="{'is-invalid': selectedCar.regNumber && !isValidRegNumber(selectedCar.regNumber)}">
              <div class="invalid-feedback" *ngIf="selectedCar.regNumber && !isValidRegNumber(selectedCar.regNumber)">
                Must be 3 uppercase letters followed by 4 digits (e.g., AEE9375)
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Make</label>
              <input type="text" class="form-control" [(ngModel)]="selectedCar.make" name="make" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Model</label>
              <input type="text" class="form-control" [(ngModel)]="selectedCar.model" name="model" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Year</label>
              <input type="number" class="form-control" [(ngModel)]="selectedCar.year" name="year" min="1900" [max]="currentYear" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Owner</label>
              <input type="text" class="form-control" [(ngModel)]="selectedCar.owner" name="owner" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" [(ngModel)]="selectedCar.status" name="status" required>
                <option value="">Select status</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="handleModalCancel()">Cancel</button>
              <button type="submit" class="btn btn-primary" [disabled]="!selectedCar.regNumber || !isValidRegNumber(selectedCar.regNumber) || !selectedCar.make || !selectedCar.model || !selectedCar.year || !selectedCar.owner || !selectedCar.status">OK</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="isModalVisible" class="modal-backdrop fade show"></div>

  <!-- Insurance Modal -->
  <div class="modal fade show" tabindex="-1" style="display: block; background: rgba(0,0,0,0.3);" *ngIf="isInsuranceModalVisible && (userRole === 'AGENT' || userRole === 'SUPER_ADMIN')">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Insure Car</h5>
          <button type="button" class="btn-close" (click)="handleInsuranceModalCancel()"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="handleInsuranceModalOk()">
            <div class="mb-3">
              <label class="form-label">Number of Terms (4 months each)</label>
              <input type="number" class="form-control" [(ngModel)]="insuranceTermCount" name="insuranceTermCount" min="1" (ngModelChange)="onInsuranceTermCountChange($event)" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-control" [(ngModel)]="insuranceStartDate" name="insuranceStartDate" (ngModelChange)="onInsuranceTermCountChange(insuranceTermCount)" required>
            </div>
            <div class="mb-3">
              <label class="form-label">End Date</label>
              <input type="date" class="form-control" [value]="insuranceEndDate" name="insuranceEndDate" readonly>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="handleInsuranceModalCancel()">Cancel</button>
              <button type="submit" class="btn btn-success">Insure</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="isInsuranceModalVisible && (userRole === 'AGENT' || userRole === 'SUPER_ADMIN')" class="modal-backdrop fade show"></div>
</div>
